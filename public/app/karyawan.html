<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karyawan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css?v=1">
  <link rel="stylesheet" href="./admin.css?v=2">
</head>
<body>
  <div class="layout">
    <aside class="sidebar" data-include="sidebar"></aside>
    <main class="main">
      <div class="topbar" data-include="header"></div>
      <div class="content">
        <h2 class="page-title">Karyawan</h2>
        <div class="cards cards-2">
          <div class="card">
            <h3>Daftar Karyawan</h3>
            <div class="table-tools">
              <div class="row" style="gap:8px;align-items:center">
                <label>Limit <select id="limitKar"><option>10</option><option selected>20</option><option>50</option><option>100</option></select></label>
                <div id="pagerKar" class="row" style="gap:6px"></div>
              </div>
            </div>
      <table class="table">
              <thead>
        <tr><th>Kode</th><th>Nama</th><th>Jabatan</th><th>Akses</th><th>Aksi</th></tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>Tambah Karyawan</h3>
            <form id="f">
              <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;">
        <div><label>Kode</label><input name="kode" placeholder="(kosongkan untuk otomatis)" maxlength="50"></div>
                <div><label>Nama</label><input name="nama" required maxlength="150"></div>
                <div><label>Jabatan</label><input name="jabatan" required maxlength="100"></div>
                <div>
                  <label>Akses</label>
                  <select name="level_akses" required>
                    <option value="farmasi">farmasi</option>
                    <option value="kasir">kasir</option>
                    <option value="gudang">gudang</option>
                    <option value="admin">admin</option>
                  </select>
                </div>
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="btn" type="submit">Simpan</button>
                <span class="error" id="err"></span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="./app.js?v=2"></script>
  <script src="./include.js?v=1"></script>
  <script>
  window.SIDEBAR_ACTIVE = 'karyawan';
  (async function(){ const r = await fetchJSON(api('/api/me')); if(!r.data || !r.data.user){ location.href='./login.html'; } })();
    let pageKar=1;
    async function loadList(){
      const lim=parseInt(document.getElementById('limitKar').value,10)||20;
      const {data} = await fetchJSON(api(`/api/karyawan?limit=${lim}&page=${pageKar}`));
      const tbody = document.getElementById('rows');
      tbody.innerHTML='';
      (data||[]).forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><span class=\"pill\">${p.kode}</span></td><td>${p.nama||''}</td><td>${p.jabatan||''}</td><td>${p.level_akses||''}</td><td>
          <button class=\"btn btn-sm\" data-act=\"edit\" data-k=\"${p.kode}\">Edit</button>
          <button class=\"btn btn-sm danger\" data-act=\"del\" data-k=\"${p.kode}\">Hapus</button>
        </td>`;
        tbody.appendChild(tr);
      });
      renderPager();
    }
    function renderPager(){ const p=document.getElementById('pagerKar'); p.innerHTML=''; const prev=document.createElement('button'); prev.className='btn btn-sm'; prev.textContent='Prev'; prev.disabled=pageKar<=1; prev.onclick=()=>{ pageKar=Math.max(1,pageKar-1); loadList(); }; const next=document.createElement('button'); next.className='btn btn-sm'; next.textContent='Next'; next.onclick=()=>{ pageKar++; loadList(); }; const lab=document.createElement('span'); lab.style.margin='0 6px'; lab.textContent='Hal '+pageKar; p.appendChild(prev); p.appendChild(lab); p.appendChild(next); }
    document.getElementById('limitKar').addEventListener('change',()=>{ pageKar=1; loadList(); });
    const form=document.getElementById('f');
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const fd=new FormData(form);
      const body=Object.fromEntries(fd.entries());
      // kosongkan kode => auto
      if(!body.kode) delete body.kode;
      const {status,data}=await fetchJSON(api('/api/karyawan'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(status>=400){ document.getElementById('err').textContent=data&&data.errors?JSON.stringify(data.errors):(data&&data.error||'Gagal'); }
      else{ form.reset(); document.getElementById('err').textContent=''; loadList(); alert('Tersimpan. Kode: '+(data&&data.kode?data.kode:body.kode)); }
    });
    // Row actions
    document.addEventListener('click', async (e)=>{
      const btn=e.target.closest('button'); if(!btn) return; const act=btn.getAttribute('data-act'); const kode=btn.getAttribute('data-k'); if(!act||!kode) return;
      if(act==='del'){ if(!confirm('Hapus karyawan '+kode+'?')) return; const r=await fetchJSON(api('/api/karyawan/'+encodeURIComponent(kode)),{method:'DELETE'}); if(r.status>=400){ alert('Gagal: '+(r.data&&r.data.error||r.raw||r.status)); } else { loadList(); } }
      if(act==='edit'){
        const r=await fetchJSON(api('/api/karyawan/'+encodeURIComponent(kode))); if(r.status>=400||!r.data){ alert('Gagal ambil data'); return; }
        const o=r.data; const nama=prompt('Nama', o.nama||''); if(nama===null) return; const jab=prompt('Jabatan', o.jabatan||''); if(jab===null) return; const akses=prompt('Akses (farmasi/kasir/gudang/admin)', o.level_akses||''); if(akses===null) return;
        const rs=await fetchJSON(api('/api/karyawan/'+encodeURIComponent(kode)),{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({nama:nama,jabatan:jab,level_akses:akses})}); if(rs.status>=400){ alert('Gagal update'); } else { loadList(); }
      }
    });
    function filterRows(q){ q=(q||'').toLowerCase(); document.querySelectorAll('#rows tr').forEach(tr=>{ const t=tr.textContent.toLowerCase(); tr.style.display=t.includes(q)?'':'none'; }); }
    loadList();
  </script>
</body>
</html>
