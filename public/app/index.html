<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apotek - Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css?v=1">
  <link rel="stylesheet" href="./admin.css?v=1">
</head>
<body>
  <div class="layout">
  <aside class="sidebar" data-include="sidebar"></aside>
    <main class="main">
      <div class="topbar" data-include="header"></div>
      <div class="content">
        <div class="card" style="margin-bottom:12px">
          <div class="search"><input placeholder="Cari obat..." oninput="filterRows(this.value)"/></div>
        </div>
        <h2 class="page-title">Obat</h2>
        <div class="cards cards-2">
          <div class="card">
            <h3>Daftar Obat</h3>
            <div class="table-tools">
              <div class="row" style="gap:8px;align-items:center">
                <label>Limit <select id="limitObat"><option>10</option><option selected>20</option><option>50</option><option>100</option></select></label>
                <div id="pagerObat" class="row" style="gap:6px"></div>
              </div>
            </div>
            <table class="table">
              <thead>
                <tr><th>Kode</th><th>Nama</th><th>Golongan</th><th>Harga</th><th>Stok</th><th>Expired</th><th>Aksi</th></tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div class="card">
            <h3 id="formTitle">Tambah Obat</h3>
            <form id="fObat">
              <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;">
                <div><label>Kode</label><input id="inKode" name="kode" maxlength="50" placeholder="(otomatis jika kosong)"></div>
                <div><label>Nama</label><input name="nama" required maxlength="255"></div>
                <div><label>Produsen</label><input name="produsen" maxlength="255"></div>
                <div><label>Harga</label><input name="harga" type="number" step="0.01" min="0" required></div>
                <div><label>Stok</label><input name="stok" type="number" min="0" required></div>
                <div><label>Expired</label><input name="expired_date" type="date" required></div>
                <div><label>Golongan</label>
                  <select name="golongan" required>
                    <option>OTC</option>
                    <option>OBT</option>
                    <option>OK</option>
                    <option>Psikotropika</option>
                    <option>Narkotika</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
                <button class="btn" type="submit" id="btnSubmit">Simpan</button>
                <button class="btn btn-sm" type="button" id="btnCancel" style="display:none;">Batal</button>
                <span class="error" id="err"></span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="./app.js?v=2"></script>
  <script src="./include.js?v=1"></script>
  <script>
  window.SIDEBAR_ACTIVE = 'obat';
  // auth guard
  (async function(){ const r = await fetchJSON(api('/api/me')); if(!r.data || !r.data.user){ location.href='./login.html'; } })();
  // Set default expired date to today for convenience if empty
  (function(){ const f=document.getElementById('fObat'); if(!f) return; const d=f.querySelector('input[name=expired_date]'); if(d && !d.value){ d.value = new Date().toISOString().slice(0,10); } })();
    let editingKode = null;

    let pageObat=1;
    async function loadObat(){
      const lim = parseInt(document.getElementById('limitObat').value,10)||20;
      const {data} = await fetchJSON(api(`/api/obat?limit=${lim}&page=${pageObat}`));
      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';
      (data||[]).forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><span class=\"pill\">${o.kode}</span></td>`+
          `<td>${o.nama||''}</td>`+
          `<td>${o.golongan||''}</td>`+
          `<td>Rp ${fmtIDR(o.harga)}</td>`+
          `<td>${o.stok}</td>`+
          `<td>${o.expired_date||''}</td>`+
          `<td><div class=\"row\" style=\"gap:6px;\">`+
            `<button class=\"btn btn-sm\" data-act=\"edit\">Edit</button>`+
            `<button class=\"btn btn-sm\" data-act=\"del\">Hapus</button>`+
          `</div></td>`;
        tr.querySelector('[data-act=edit]').onclick = () => startEdit(o);
        tr.querySelector('[data-act=del]').onclick = () => deleteObat(o.kode);
        tbody.appendChild(tr);
      });
      renderPager();
    }
    function renderPager(){
      const p=document.getElementById('pagerObat');
      p.innerHTML='';
      const prev=document.createElement('button'); prev.className='btn btn-sm'; prev.textContent='Prev'; prev.disabled = pageObat<=1; prev.onclick=()=>{ pageObat=Math.max(1,pageObat-1); loadObat(); };
      const next=document.createElement('button'); next.className='btn btn-sm'; next.textContent='Next'; next.onclick=()=>{ pageObat++; loadObat(); };
      const label=document.createElement('span'); label.style.margin='0 6px'; label.textContent = 'Hal '+pageObat;
      p.appendChild(prev); p.appendChild(label); p.appendChild(next);
    }
    document.getElementById('limitObat').addEventListener('change',()=>{ pageObat=1; loadObat(); });

    // simple client filter for the table
    function filterRows(q){
      q=(q||'').toLowerCase();
      document.querySelectorAll('#rows tr').forEach(tr=>{
        const txt=tr.textContent.toLowerCase();
        tr.style.display = txt.includes(q)?'':'none';
      });
    }

    function startEdit(o){
      editingKode = o.kode;
      document.getElementById('formTitle').textContent = 'Edit Obat';
      document.getElementById('btnSubmit').textContent = 'Update';
      document.getElementById('btnCancel').style.display = '';
      const f = document.getElementById('fObat');
      f.kode.value = o.kode; f.kode.disabled = true;
      f.nama.value = o.nama||'';
      f.produsen.value = o.produsen||'';
      f.harga.value = o.harga||0;
      f.stok.value = o.stok||0;
      f.expired_date.value = o.expired_date||'';
      f.golongan.value = o.golongan||'OTC';
      f.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function resetForm(){
      editingKode = null;
      const f = document.getElementById('fObat');
      f.reset();
      f.kode.disabled = false;
      document.getElementById('formTitle').textContent = 'Tambah Obat';
      document.getElementById('btnSubmit').textContent = 'Simpan';
      document.getElementById('btnCancel').style.display = 'none';
      document.getElementById('err').textContent = '';
    }

    document.getElementById('btnCancel').addEventListener('click', resetForm);

    async function deleteObat(kode){
      if(!confirm('Hapus obat '+kode+'?')) return;
      const {status, data} = await fetchJSON(api('/api/obat/'+encodeURIComponent(kode)), { method:'DELETE' });
      if(status>=400){
        alert((data && (data.error||JSON.stringify(data.errors))) || 'Gagal hapus');
      } else {
        resetForm();
        loadObat();
      }
    }

    document.getElementById('fObat').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = Object.fromEntries(fd.entries());
      body.harga = parseFloat(body.harga||0);
      body.stok = parseInt(body.stok||0,10);
      let res;
      if(editingKode){
        res = await fetchJSON(api('/api/obat/'+encodeURIComponent(editingKode)),{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      } else {
        res = await fetchJSON(api('/api/obat'),{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      }
      const {status, data} = res;
      if(status>=400){
        document.getElementById('err').textContent = data && data.errors? JSON.stringify(data.errors) : (data && data.error || 'Gagal');
      } else {
        resetForm();
        loadObat();
      }
    });

  loadObat();
  </script>
</body>
</html>
