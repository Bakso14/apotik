<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interaksi Obat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css?v=1">
  <link rel="stylesheet" href="./admin.css?v=2">
</head>
<body>
  <div class="layout">
    <aside class="sidebar" data-include="sidebar"></aside>
    <main class="main">
      <div class="topbar" data-include="header"></div>
      <div class="content">
        <h2 class="page-title">Interaksi Obat</h2>
        <div class="cards cards-2">
          <div class="card">
            <h3>Daftar Interaksi</h3>
            <div class="table-tools">
              <div class="row" style="gap:8px;align-items:center">
                <label>Limit <select id="limitInt"><option>10</option><option selected>20</option><option>50</option><option>100</option><option>200</option></select></label>
                <div id="pagerInt" class="row" style="gap:6px"></div>
              </div>
            </div>
      <table class="table">
              <thead>
        <tr><th>Obat 1</th><th>Obat 2</th><th>Tingkat</th><th>Keterangan</th><th>Aksi</th></tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>Tambah Interaksi</h3>
            <form id="f">
              <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;">
                <div><label>Obat 1 Kode</label><input name="obat1_kode" required></div>
                <div><label>Obat 2 Kode</label><input name="obat2_kode" required></div>
                <div>
                  <label>Tingkat</label>
                  <select name="tingkat" required>
                    <option value="minor">minor</option>
                    <option value="moderate">moderate</option>
                    <option value="major">major</option>
                    <option value="contraindicated">contraindicated</option>
                  </select>
                </div>
                <div style="grid-column:1/-1"><label>Keterangan</label><input name="keterangan"></div>
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="btn" type="submit">Simpan</button>
                <span class="error" id="err"></span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="./app.js?v=2"></script>
  <script src="./include.js?v=1"></script>
  <script>
  window.SIDEBAR_ACTIVE = 'interaksi';
  (async function(){ const r = await fetchJSON(api('/api/me')); if(!r.data || !r.data.user){ location.href='./login.html'; } })();
    let pageInt=1;
    async function loadList(){
      const lim=parseInt(document.getElementById('limitInt').value,10)||20;
      const {data} = await fetchJSON(api(`/api/interaksi?limit=${lim}&page=${pageInt}`));
      const tbody = document.getElementById('rows');
      tbody.innerHTML='';
      (data||[]).forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${p.obat1_kode}</td><td>${p.obat2_kode}</td><td>${p.tingkat}</td><td>${p.keterangan||''}</td><td>
          <button class="btn btn-sm" data-act="edit" data-id="${p.id}">Edit</button>
          <button class="btn btn-sm danger" data-act="del" data-id="${p.id}">Hapus</button>
        </td>`;
        tbody.appendChild(tr);
      });
      renderPager();
    }
    function renderPager(){ const p=document.getElementById('pagerInt'); p.innerHTML=''; const prev=document.createElement('button'); prev.className='btn btn-sm'; prev.textContent='Prev'; prev.disabled=pageInt<=1; prev.onclick=()=>{ pageInt=Math.max(1,pageInt-1); loadList(); }; const next=document.createElement('button'); next.className='btn btn-sm'; next.textContent='Next'; next.onclick=()=>{ pageInt++; loadList(); }; const lab=document.createElement('span'); lab.style.margin='0 6px'; lab.textContent='Hal '+pageInt; p.appendChild(prev); p.appendChild(lab); p.appendChild(next); }
    document.getElementById('limitInt').addEventListener('change',()=>{ pageInt=1; loadList(); });
    const form=document.getElementById('f');
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const fd=new FormData(form);
      const body=Object.fromEntries(fd.entries());
      const {status,data}=await fetchJSON(api('/api/interaksi'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(status>=400){ document.getElementById('err').textContent=data&&data.errors?JSON.stringify(data.errors):(data&&data.error||'Gagal'); }
      else{ form.reset(); document.getElementById('err').textContent=''; loadList(); }
    });
    document.addEventListener('click', async (e)=>{
      const btn=e.target.closest('button'); if(!btn) return; const act=btn.getAttribute('data-act'); const id=btn.getAttribute('data-id'); if(!act||!id) return;
      if(act==='del'){ if(!confirm('Hapus interaksi #'+id+'?')) return; const r=await fetchJSON(api('/api/interaksi/'+id),{method:'DELETE'}); if(r.status>=400){ alert('Gagal: '+(r.data&&r.data.error||r.raw||r.status)); } else { loadList(); } }
      if(act==='edit'){
        const tingkat=prompt('Tingkat (minor/moderate/major/contraindicated)','minor'); if(tingkat===null) return; const keterangan=prompt('Keterangan',''); if(keterangan===null) return;
        const rs=await fetchJSON(api('/api/interaksi/'+id),{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({tingkat:tingkat,keterangan:keterangan})}); if(rs.status>=400){ alert('Gagal update'); } else { loadList(); }
      }
    });
    function filterRows(q){ q=(q||'').toLowerCase(); document.querySelectorAll('#rows tr').forEach(tr=>{ const t=tr.textContent.toLowerCase(); tr.style.display=t.includes(q)?'':'none'; }); }
    loadList();
  </script>
</body>
</html>
