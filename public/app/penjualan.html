<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Penjualan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css?v=1">
  <style>
    :root{ --blue:#0b74de; --blue2:#0a66c2; --green:#12b76a; --bg:#f5f7fb; --card:#ffffff; --muted:#667085; }
    body{ background:var(--bg); }
    .appbar{ background:var(--blue); color:#fff; padding:10px 16px; position:sticky; top:0; z-index:5; }
    .appbar .row{ display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .search-wrap{ display:flex; gap:8px; align-items:center; flex:1; max-width:900px; }
    .search{ position:relative; flex:1; }
    .search input{ width:100%; padding:12px 14px; border-radius:999px; border:none; outline:0; font-size:14px; }
  .search .sugg{ position:absolute; left:0; right:0; top:100%; background:#fff; border:1px solid #e6e6e6; border-radius:10px; box-shadow:0 10px 24px rgba(16,24,40,.1); overflow:auto; max-height:320px; z-index:1000; }
  .sugg-item{ padding:10px 12px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
  .sugg-item.active{ background:#eef2f6; }
    .sugg-item:hover{ background:#f9fafb; }
    .brand{ font-weight:600; }
    .total-top{ font-weight:700; font-size:18px; }
    .pos{ display:grid; grid-template-columns: 1.6fr .9fr; gap:16px; padding:16px; }
    .card{ background:var(--card); border-radius:12px; box-shadow:0 1px 2px rgba(16,24,40,.05); padding:14px; }
    .cart-item{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; border-bottom:1px dashed #eef2f6; padding:10px 0; }
    .title{ font-weight:600; }
    .muted{ color:var(--muted); font-size:12px; }
    .price{ color:#16a34a; font-weight:600; }
    .qty{ display:flex; align-items:center; gap:6px; }
    .icon-btn{ width:28px; height:28px; border-radius:50%; border:none; background:#eef2f6; display:grid; place-items:center; cursor:pointer; }
    .icon-btn:active{ transform:scale(.96); }
    .delete{ color:#b42318; }
    .right{ text-align:right; }
    .summary h4{ margin:0 0 10px; }
    .summary .row{ display:flex; justify-content:space-between; padding:6px 0; }
    .summary input{ width:120px; text-align:right; }
    .pay{ margin-top:12px; width:100%; background:var(--green); color:#fff; border:none; padding:12px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    .pay:active{ transform:scale(.99); }
    .bottom-nav{ position:sticky; bottom:0; background:#fff; border-top:1px solid #e6e6e6; display:flex; gap:8px; justify-content:space-around; padding:10px 8px; }
    .nav-btn{ display:flex; flex-direction:column; align-items:center; gap:4px; font-size:12px; color:#344054; text-decoration:none; }
    @media (max-width: 900px){ .pos{ grid-template-columns: 1fr; } }
    /* print area */
    .printable{ display:none; }
    /* Receipt (struk) styles */
  .receipt{ width:280px; margin:0 auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:#111; }
  .rc-center{ text-align:center; }
  .rc-row{ display:flex; justify-content:space-between; gap:8px; }
  .rc-sep{ border-top:1px dashed #999; margin:6px 0; }
  .rc-items{ margin:6px 0; }
  .rc-item{ margin:4px 0; }
  .rc-item .name{ font-weight:600; }
  .rc-item .meta{ display:flex; justify-content:space-between; }
  .rc-small{ color:#555; font-size:11px; }
  .rc-total .rc-row{ font-weight:700; }
  /* Etiket (A4 grid, 2 columns) */
  .labels-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:8mm; }
  .label-box{ border:1px solid #111; padding:4mm; height: 58mm; box-sizing:border-box; }
  .lb-head{ text-align:center; font-weight:700; text-transform:uppercase; }
  .lb-sub{ text-align:center; text-decoration:underline; margin-top:1mm; }
  .lb-row{ display:grid; grid-template-columns: 24mm 1fr 20mm 24mm; gap:1mm; align-items:center; }
  .lb-row + .lb-row{ margin-top:1.2mm; }
  .lb-colspan{ grid-column: 1 / -1; }
  .lb-small{ font-size: 11px; }
  .lb-checks{ display:grid; grid-template-columns: repeat(1, 1fr); gap:1mm; }
  .lb-check{ display:flex; align-items:center; gap:2mm; }
  .box{ width:10px; height:10px; border:1px solid #111; display:inline-block; }
  .lb-footer{ text-align:center; margin-top:2mm; }
  @media print{ .labels-grid{ gap:7mm; } .label-box{ page-break-inside: avoid; } }
    /* Page margins for print */
    @page { margin: 6mm; }
    /* Print only the #print area */
    @media print{
      body{ background:#fff; }
      body *{ visibility:hidden !important; }
      #print, #print *{ visibility:visible !important; }
      #print{ display:block !important; position:absolute; left:0; right:0; top:0; margin:0 auto; }
    }
  </style>
</head>
<body>
  <header class="appbar no-print">
    <div class="row">
      <div style="display:flex; align-items:center; gap:8px">
        <a href="./dashboard.html" class="icon-btn" title="Kembali ke Dashboard" aria-label="Kembali ke Dashboard">‚¨ÖÔ∏è</a>
        <div class="brand">Kasir</div>
      </div>
      <div class="search-wrap">
        <div class="search">
          <input id="q" placeholder="Ketik Nama Produk" />
          <div id="sugg" class="sugg" style="display:none"></div>
        </div>
        <button id="btnScan" class="icon-btn" title="Scan">üì∑</button>
        <button id="btnHold" class="icon-btn" title="Tahan">‚è∏Ô∏è</button>
      </div>
      <div class="total-top" id="totalTop">Rp 0</div>
    </div>
  </header>

  <div class="pos">
    <div>
      <div class="card">
        <div class="muted" style="margin-bottom:6px">Keranjang</div>
        <div id="cart"></div>
      </div>
      <div class="no-print" style="margin-top:8px">
        <button class="btn btn-sm" id="btnManual">+ Tambah manual</button>
      </div>
      <div id="manual" class="card no-print" style="margin-top:8px; display:none;">
        <div class="row" style="flex-wrap:wrap; gap:8px; align-items:flex-end;">
          <div style="position:relative">
            <label>Kode/Nama</label>
            <input id="mKode" placeholder="Ketik kode atau nama" />
            <div id="mSugg" class="sugg" style="display:none; position:absolute; left:0; right:0; top:100%; background:#fff; border:1px solid #e6e6e6; border-radius:10px; box-shadow:0 10px 24px rgba(16,24,40,.1); overflow:auto; max-height:260px; z-index:1000;"></div>
          </div>
          <div>
            <label>Qty</label>
            <input id="mQty" type="number" min="1" value="1" style="width:90px" />
          </div>
          <div>
            <label>Harga</label>
            <input id="mHarga" type="number" min="0" step="100" style="width:140px" />
          </div>
          <div>
            <label>Dosis</label>
            <input id="mDosis" placeholder="opsional" style="width:200px" />
          </div>
          <div>
            <label>Etiket</label>
            <input id="mEtiket" placeholder="opsional" style="width:240px" />
          </div>
          <div>
            <button class="btn" id="mAdd">Tambahkan</button>
          </div>
        </div>
        <div id="mHelp" class="muted" style="margin-top:6px">Harga otomatis terisi jika kode/nama dikenali.</div>
      </div>
      <div class="card no-print" style="margin-top:12px">
        <div class="title" style="margin-bottom:8px">Riwayat Terakhir</div>
        <div class="row" style="gap:8px; align-items:end; flex-wrap:wrap; margin-bottom:8px">
          <div>
            <label>Tgl</label>
            <input id="f_tgl" type="date" />
          </div>
          <div><div class="muted">atau rentang</div></div>
          <div>
            <label>Dari</label>
            <input id="f_from" type="date" />
          </div>
          <div>
            <label>Sampai</label>
            <input id="f_to" type="date" />
          </div>
          <div>
            <button class="btn btn-sm" id="f_apply">Terapkan</button>
            <button class="btn btn-sm" id="f_today">Hari ini</button>
          </div>
        </div>
        <table class="table"><thead><tr><th>No</th><th>Tgl</th><th>Jenis</th><th>Pelanggan</th><th>Total</th><th>Aksi</th></tr></thead><tbody id="hist"></tbody></table>
      </div>
    </div>

    <div>
      <div class="card summary">
        <h4>Ringkasan Transaksi</h4>
        <div class="row"><div>No Nota</div><div style="display:flex; gap:6px; align-items:center">
          <input id="noNota" placeholder="otomatis" style="width:180px" readonly>
          <button class="btn btn-sm" id="regenNota" title="Buat ulang">‚Üª</button>
        </div></div>
        <div class="row"><div>Nama Pelanggan</div><div><input id="pelanggan" placeholder="-" /></div></div>
        <div class="row"><div>Jenis</div><div>
          <select id="jenis"><option>OTC</option><option>Resep</option><option>Racik</option></select>
        </div></div>
        <div class="row"><div>Dokter SIP</div><div><input id="dokter" placeholder="opsional" /></div></div>
        <hr/>
        <div id="mini" class="muted" style="max-height:160px;overflow:auto"></div>
        <hr/>
        <div class="row"><div>Biaya Service</div><div><input id="srv" type="number" min="0" step="1000" value="0"></div></div>
        <div class="row"><div>Biaya Embalase</div><div><input id="emb" type="number" min="0" step="500" value="0"></div></div>
        <div class="row"><div>Ongkos Kirim</div><div><input id="ong" type="number" min="0" step="1000" value="0"></div></div>
        <div class="row"><div>Biaya Tambahan</div><div><input id="add" type="number" min="0" step="1000" value="0"></div></div>
        <div class="row"><div>Diskon</div><div><input id="disc" type="number" min="0" step="1000" value="0"></div></div>
        <hr/>
    <div class="row"><div><strong>Total</strong></div><div id="totalRight"><strong>Rp 0</strong></div></div>
  <div class="row no-print" style="gap:6px; margin-top:8px"><button class="btn btn-sm" id="saveDraft">Simpan Draf</button><button class="btn btn-sm" id="clearDraft">Bersihkan Draf</button><span id="draftHint" class="muted" style="font-size:12px"></span></div>
    <button class="pay" id="pay">Lanjut Pembayaran</button>
    <div id="payErr" class="error" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <div id="print" class="printable"></div>

  <div class="bottom-nav no-print" style="display:none">
    <a class="nav-btn" href="./pelanggan.html">üë§<span>Pelanggan</span></a>
    <a class="nav-btn" href="./">üíä<span>Obat</span></a>
    <a class="nav-btn" href="#" id="btnEtiket">üè∑Ô∏è<span>Etiket</span></a>
    <a class="nav-btn" href="#" id="btnInfo">‚ÑπÔ∏è<span>Info</span></a>
    <a class="nav-btn" href="#" id="btnHold2">üïì<span>Tunda</span></a>
  </div>

  <script src="./app.js?v=2"></script>
  <script src="./include.js?v=1"></script>
  <script>
  window.SIDEBAR_ACTIVE = 'penjualan';
  // auth guard
  (async function(){ const r = await fetchJSON(api('/api/me')); if(!r.data || !r.data.user){ location.href='./login.html'; } })();
  // Header info for receipt (edit as needed)
  const STORE = { name: 'Apotek', address: 'Jl. Contoh No. 1, Kota', phone: '0812-3456-7890' };
  const DRAFT_KEY = 'pos_draft_v1';
    const cart = [];
    const charges = { srv:0, emb:0, ong:0, add:0, disc:0 };
    const q = document.getElementById('q');
    const sugg = document.getElementById('sugg');
    let suggIndex = -1; // highlighted index in suggestion list
    function setActiveSuggestion(idx){
      const items = Array.from(sugg.querySelectorAll('.sugg-item'));
      items.forEach((el,i)=>{ if(i===idx) el.classList.add('active'); else el.classList.remove('active'); });
      suggIndex = items.length ? Math.max(-1, Math.min(idx, items.length-1)) : -1;
      if(suggIndex>=0){ items[suggIndex].scrollIntoView({block:'nearest'}); }
    }
    function applySuggestion(idx){
      const items = Array.from(sugg.querySelectorAll('.sugg-item'));
      if(!items.length) return;
      const i = (typeof idx==='number' && idx>=0) ? idx : 0;
      const el = items[i];
      addToCart({ kode:el.dataset.k, nama:el.dataset.n, harga:+el.dataset.h, stok:+el.dataset.s });
      sugg.style.display='none'; sugg.innerHTML=''; q.value=''; suggIndex=-1;
    }
    const elCart = document.getElementById('cart');
  // manual add refs
  const mWrap = document.getElementById('manual');
  const mBtn = document.getElementById('btnManual');
  const mKode = document.getElementById('mKode');
  const mQty = document.getElementById('mQty');
  const mHarga = document.getElementById('mHarga');
  const mDosis = document.getElementById('mDosis');
  const mEtiket = document.getElementById('mEtiket');
  const mAdd = document.getElementById('mAdd');
  const mSugg = document.getElementById('mSugg');

  function fmt(n){ try { return Number(n||0).toLocaleString('id-ID'); } catch(e){ return n; } }
  // --- Nota generator (client-side) mirrors server format PJYYYYMMDDHHMMSS + 3 rand digits
  function pad2(n){ return String(n).padStart(2,'0'); }
  function genNota(){ const d=new Date(); const ts = d.getFullYear()+''+pad2(d.getMonth()+1)+pad2(d.getDate())+pad2(d.getHours())+pad2(d.getMinutes())+pad2(d.getSeconds()); const rnd = Math.floor(100+Math.random()*900); return 'PJ'+ts+rnd; }
  function setNota(v){ const el=document.getElementById('noNota'); if(el){ el.value = v||genNota(); } }

    function recalc(){
      let sub = 0;
      cart.forEach(it => sub += it.qty * (it.harga_jual||0));
      const total = sub + (+charges.srv||0) + (+charges.emb||0) + (+charges.ong||0) + (+charges.add||0) - (+charges.disc||0);
      document.getElementById('totalTop').textContent = 'Rp '+fmt(total);
      document.getElementById('totalRight').innerHTML = '<strong>Rp '+fmt(total)+'</strong>';
      // mini summary
      const mini = document.getElementById('mini');
      mini.innerHTML = cart.map(x=>`<div class="row"><div>${x.nama||x.obat_kode} x ${x.qty}</div><div>Rp ${fmt(x.qty*x.harga_jual)}</div></div>`).join('');
  updateDraftHint();
    }

    function renderCart(){
      elCart.innerHTML = cart.map(x => {
        return `<div class="cart-item">
          <div>
            <div class="title">${x.nama||x.obat_kode}</div>
            <div class="muted">Stok: ${x.stok??'-'} ¬∑ Harga: <span class="price">Rp ${fmt(x.harga_jual)}</span></div>
          </div>
          <div class="qty">
            <button class="icon-btn" data-act="minus" data-k="${x.obat_kode}">‚àí</button>
            <div>${x.qty}</div>
            <button class="icon-btn" data-act="plus" data-k="${x.obat_kode}">+</button>
            <button class="icon-btn delete" title="Hapus" data-act="del" data-k="${x.obat_kode}">üóëÔ∏è</button>
            <button class="icon-btn" title="Etiket" data-act="etiket" data-k="${x.obat_kode}">üè∑Ô∏è</button>
          </div>
        </div>`;
      }).join('');
      // bind buttons
      elCart.querySelectorAll('[data-act]')?.forEach(btn => {
        btn.onclick = () => {
          const k = btn.getAttribute('data-k');
          const it = cart.find(i => i.obat_kode===k);
          if(!it) return;
          const act = btn.getAttribute('data-act');
          if(act==='plus'){ it.qty++; }
          else if(act==='minus'){ it.qty = Math.max(1, it.qty-1); }
          else if(act==='del'){ const idx = cart.findIndex(i=>i.obat_kode===k); if(idx>=0) cart.splice(idx,1); }
          else if(act==='etiket'){ const v = prompt('Etiket untuk '+(it.nama||it.obat_kode), it.etiket||''); if(v!==null) it.etiket=v; }
          renderCart(); recalc();
        }
      });
      recalc();
  saveDraft();
    }

    function addToCart(o){
      const exist = cart.find(x => x.obat_kode===o.kode);
      if(exist){ exist.qty++; exist.harga_jual = o.harga; }
      else { cart.push({ obat_kode:o.kode, nama:o.nama, harga_jual:o.harga, stok:o.stok, qty:1 }); }
      renderCart();
    }

    // --- Draft (Hold) helpers ---
    function captureState(){
      return {
        cart: cart.map(x=>({ obat_kode:x.obat_kode, nama:x.nama, harga_jual:x.harga_jual, stok:x.stok, qty:x.qty, dosis:x.dosis||null, etiket:x.etiket||null })),
        charges: { ...charges },
        meta: {
          pelanggan: document.getElementById('pelanggan').value||'',
          jenis: document.getElementById('jenis').value||'OTC',
          dokter: document.getElementById('dokter').value||''
        },
        ts: Date.now()
      };
    }
    function saveDraft(){
      try{
        const state=captureState();
        const hasItems = Array.isArray(state.cart) && state.cart.length>0;
        const hasMeta = (state.meta.pelanggan||'') || (state.meta.dokter||'') || (state.charges.srv||state.charges.emb||state.charges.ong||state.charges.add||state.charges.disc);
        if(hasItems || hasMeta){ localStorage.setItem(DRAFT_KEY, JSON.stringify(state)); }
        else { localStorage.removeItem(DRAFT_KEY); }
        updateDraftHint();
      }catch(e){}
    }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(DRAFT_KEY); if(!raw) return false;
        const state = JSON.parse(raw);
        // apply meta
        document.getElementById('pelanggan').value = state?.meta?.pelanggan || '';
        document.getElementById('jenis').value = state?.meta?.jenis || 'OTC';
        document.getElementById('dokter').value = state?.meta?.dokter || '';
        // apply charges
        Object.assign(charges, state?.charges||{});
        ['srv','emb','ong','add','disc'].forEach(id=>{ const el=document.getElementById(id); if(el && state?.charges && id in state.charges){ el.value = state.charges[id]; }});
        // apply cart
        cart.splice(0, cart.length);
        (state?.cart||[]).forEach(x=>cart.push({ ...x }));
        renderCart();
        return true;
      }catch(e){ return false; }
    }
    function clearDraft(){ try{ localStorage.removeItem(DRAFT_KEY); updateDraftHint(); }catch(e){} }
    function updateDraftHint(){
      const el = document.getElementById('draftHint'); if(!el) return;
      try{
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw){ el.textContent=''; return; }
        const s = JSON.parse(raw);
        const n = (s.cart||[]).length||0;
        const d = new Date(s.ts||Date.now());
        const hh = String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
        el.textContent = `Draf tersimpan (${n} item, ${hh})`;
      }catch(e){ el.textContent=''; }
    }

    // manual add handlers
    mBtn.addEventListener('click', () => {
      mWrap.style.display = (mWrap.style.display==='none' || mWrap.style.display==='') ? '' : 'none';
      if(mWrap.style.display!=='none'){ mKode.focus(); }
    });

    async function lookupObat(term){
      if(!term) return null;
      const res = await fetchJSON(api('/api/obat?q='+encodeURIComponent(term)));
      let list = Array.isArray(res.data) ? res.data : null;
      if(!list || !list.length){
        // fallback: load all and filter client-side
        const all = await fetchJSON(api('/api/obat'));
        if(Array.isArray(all.data)){
          const t = String(term).toLowerCase();
          list = all.data.filter(o => String(o.kode||'').toLowerCase().includes(t) || String(o.nama||'').toLowerCase().includes(t));
        }
      }
      if(!list || !list.length) return null;
      const t2 = String(term).toLowerCase();
      const exact = list.find(x => String(x.kode||'').toLowerCase()===t2);
      return exact || list[0];
    }
    mKode.addEventListener('change', async () => {
      const res = await lookupObat(mKode.value.trim());
      if(res){
        mHarga.value = res.harga||0;
        mKode.dataset.kode = res.kode||'';
        mKode.dataset.nama = res.nama||'';
        mKode.dataset.stok = res.stok||'';
      } else {
        mHarga.placeholder = 'Tidak ditemukan';
        delete mKode.dataset.kode; delete mKode.dataset.nama; delete mKode.dataset.stok;
      }
    });
    mKode.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); mAdd.click(); }});
    // simple inline suggestions under mKode
    let mTmr=null;
    mKode.addEventListener('input', () => {
      clearTimeout(mTmr);
      const v = mKode.value.trim();
      if(v.length<1){ mSugg.style.display='none'; mSugg.innerHTML=''; return; }
      mTmr = setTimeout(async () => {
        const res = await fetchJSON(api('/api/obat?q='+encodeURIComponent(v)));
        let list = Array.isArray(res.data) ? res.data : null;
        if(!list || !list.length){
          const all = await fetchJSON(api('/api/obat'));
          if(Array.isArray(all.data)){
            const t = v.toLowerCase();
            list = all.data.filter(o => String(o.kode||'').toLowerCase().includes(t) || String(o.nama||'').toLowerCase().includes(t));
          }
        }
        list = (list||[]).slice(0,8);
        if(!list.length){ mSugg.innerHTML = `<div class="sugg-item"><div class="muted">Tidak ada hasil</div></div>`; mSugg.style.display='block'; return; }
        mSugg.innerHTML = list.map(o => `<div class="sugg-item" data-k="${o.kode}" data-n="${o.nama}" data-h="${o.harga}" data-s="${o.stok}"><div><div class="title">${o.nama||'-'}</div><div class="muted">${o.kode} ¬∑ Stok ${o.stok??'-'}</div></div><div class="price">Rp ${fmt(o.harga)}</div></div>`).join('');
        Array.from(mSugg.children).forEach(el => {
          el.onclick = () => {
            const kode = el.dataset.k; const nama = el.dataset.n; const harga = +el.dataset.h; const stok = +el.dataset.s;
            addToCart({ kode, nama, harga, stok });
            const it = cart.find(x => x.obat_kode===kode);
            const qty = Math.max(1, parseInt(mQty.value||'1',10));
            if(it){ it.qty = qty; if(mDosis.value) it.dosis = mDosis.value; if(mEtiket.value) it.etiket = mEtiket.value; renderCart(); }
            // reset manual fields
            mKode.value=''; mQty.value='1'; mHarga.value=''; mDosis.value=''; mEtiket.value='';
            delete mKode.dataset.kode; delete mKode.dataset.nama; delete mKode.dataset.stok;
            mSugg.style.display='none'; mSugg.innerHTML='';
          }
        });
        mSugg.style.display='block';
      }, 150);
    });
    mKode.addEventListener('blur', () => setTimeout(()=>{ mSugg.style.display='none'; }, 160));
    mAdd.addEventListener('click', async () => {
      const kodeInput = mKode.value.trim();
      if(!kodeInput){ alert('Isi kode/nama'); return; }
      let kode = mKode.dataset.kode || kodeInput;
      let nama = mKode.dataset.nama || null;
      let stok = mKode.dataset.stok ? +mKode.dataset.stok : null;
      let harga = mHarga.value ? +mHarga.value : null;
      if(harga==null){
        const res = await lookupObat(kodeInput);
        if(res){
          kode = res.kode; nama = res.nama; stok = res.stok; harga = +res.harga;
        } else {
          harga = 0;
        }
      }
      addToCart({ kode, nama, harga, stok });
      const it = cart.find(x => x.obat_kode===kode);
      const qty = Math.max(1, parseInt(mQty.value||'1',10));
      if(it){ it.qty = qty; if(mDosis.value) it.dosis = mDosis.value; if(mEtiket.value) it.etiket = mEtiket.value; renderCart(); }
      // reset manual form
      mKode.value=''; mQty.value='1'; mHarga.value=''; mDosis.value=''; mEtiket.value='';
      delete mKode.dataset.kode; delete mKode.dataset.nama; delete mKode.dataset.stok;
    });

    // search suggest
    let tmr=null;
    q.addEventListener('input', () => {
      clearTimeout(tmr);
      const v = q.value.trim();
      if(v.length<1){ sugg.style.display='none'; sugg.innerHTML=''; return; }
      tmr = setTimeout(async () => {
        const res = await fetchJSON(api('/api/obat?q='+encodeURIComponent(v)));
        let list = Array.isArray(res.data) ? res.data : null;
        if(!list || !list.length){
          // fallback to client filter
          const all = await fetchJSON(api('/api/obat'));
          if(Array.isArray(all.data)){
            const t = v.toLowerCase();
            list = all.data.filter(o => String(o.kode||'').toLowerCase().includes(t) || String(o.nama||'').toLowerCase().includes(t));
          }
        }
        list = (list||[]).slice(0,10); // show up to 10 rows
        if(!list.length){
          sugg.innerHTML = `<div class="sugg-item"><div class="muted">Tidak ada hasil</div></div>`;
          sugg.style.display='block';
          return;
        }
        sugg.innerHTML = list.map(o => `<div class="sugg-item" data-k="${o.kode}" data-n="${o.nama}" data-h="${o.harga}" data-s="${o.stok}"><div><div class="title">${o.nama||'-'}</div><div class="muted">${o.kode} ¬∑ Stok ${o.stok??'-'}</div></div><div class="price">Rp ${fmt(o.harga)}</div></div>`).join('');
        Array.from(sugg.children).forEach(el => {
          el.onclick = () => {
            addToCart({ kode:el.dataset.k, nama:el.dataset.n, harga:+el.dataset.h, stok:+el.dataset.s });
            sugg.style.display='none'; sugg.innerHTML=''; q.value='';
          }
        });
        sugg.style.display='block';
        setActiveSuggestion(-1);
      }, 200);
    });
    q.addEventListener('keydown', (e) => {
      if(sugg.style.display!=='block') return;
      const items = Array.from(sugg.querySelectorAll('.sugg-item'));
      if(!items.length) return;
      if(e.key==='ArrowDown'){
        e.preventDefault();
        const next = suggIndex < items.length-1 ? suggIndex+1 : 0;
        setActiveSuggestion(next);
      } else if(e.key==='ArrowUp'){
        e.preventDefault();
        const prev = suggIndex > 0 ? suggIndex-1 : items.length-1;
        setActiveSuggestion(prev);
      } else if(e.key==='Enter'){
        e.preventDefault();
        applySuggestion(suggIndex>=0 ? suggIndex : 0);
      } else if(e.key==='Escape'){
        sugg.style.display='none'; sugg.innerHTML=''; suggIndex=-1;
      }
    });
    q.addEventListener('blur', () => setTimeout(()=>{ sugg.style.display='none'; }, 200));

    // charges listeners
    ['srv','emb','ong','add','disc'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', () => { charges[id] = +el.value||0; recalc(); saveDraft(); });
    });
    // meta listeners
    document.getElementById('pelanggan').addEventListener('input', saveDraft);
    document.getElementById('dokter').addEventListener('input', saveDraft);
    document.getElementById('jenis').addEventListener('change', saveDraft);

  // Hold/Resume buttons
    document.getElementById('btnHold')?.addEventListener('click', ()=>{ saveDraft(); alert('Draf transaksi disimpan. Anda bisa melanjutkan nanti.'); });
    document.getElementById('btnHold2')?.addEventListener('click', ()=>{ saveDraft(); alert('Draf transaksi disimpan.'); });
    document.getElementById('saveDraft')?.addEventListener('click', ()=>{ saveDraft(); alert('Draf disimpan.'); });
    document.getElementById('clearDraft')?.addEventListener('click', ()=>{ clearDraft(); cart.splice(0,cart.length); renderCart(); alert('Draf dibersihkan.'); });

    // history
    async function loadHistory(){
      let t = document.getElementById('f_tgl').value;
      let f = document.getElementById('f_from').value;
      let to = document.getElementById('f_to').value;
      const qs = new URLSearchParams();
      // If range provided, it takes precedence over single date
      if (f || to) {
        // auto-fix reversed range
        if (f && to && f > to) { const tmp = f; f = to; to = tmp; document.getElementById('f_from').value = f; document.getElementById('f_to').value = to; }
        if (f) qs.set('tgl_from', f);
        if (to) qs.set('tgl_to', to);
      } else if (t) {
        qs.set('tgl', t);
      }
      const url = '/api/penjualan' + (qs.toString() ? ('?'+qs.toString()) : '');
      const {data} = await fetchJSON(api(url));
      const tb = document.getElementById('hist');
      tb.innerHTML = '';
      (data||[]).forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><button class="btn btn-sm" data-act="nota">${p.no_nota}</button></td><td>${p.tgl}</td><td>${p.jenis}</td><td>${p.pelanggan_kode||''}</td><td>${fmt(p.total)}</td><td class="row" style="gap:6px;"><button class="btn btn-sm" data-act="etiket">Etiket</button><button class="btn btn-sm" data-act="nota2">Nota</button></td>`;
        tr.querySelectorAll('[data-act=nota],[data-act=nota2]').forEach(el=>{ el.onclick=()=>printNota(p.id); });
        tr.querySelector('[data-act=etiket]').onclick=()=>printEtiket(p.id);
        tb.appendChild(tr);
      });
    }
    function setTodayFilters(){
      const today = new Date();
      const pad = n => String(n).padStart(2,'0');
      const d = today.getFullYear()+'-'+pad(today.getMonth()+1)+'-'+pad(today.getDate());
      document.getElementById('f_tgl').value = d;
      document.getElementById('f_from').value = '';
      document.getElementById('f_to').value = '';
    }
  // filter events
  document.getElementById('f_apply').addEventListener('click', ()=> loadHistory());
  document.getElementById('f_today').addEventListener('click', ()=> { setTodayFilters(); loadHistory(); });
  // Make fields mutually exclusive to avoid confusion
  document.getElementById('f_tgl').addEventListener('change', ()=>{ document.getElementById('f_from').value=''; document.getElementById('f_to').value=''; });
  document.getElementById('f_from').addEventListener('change', ()=>{ document.getElementById('f_tgl').value=''; });
  document.getElementById('f_to').addEventListener('change', ()=>{ document.getElementById('f_tgl').value=''; });

    // print helpers
    async function printNota(id){
      const {status,data} = await fetchJSON(api('/api/penjualan/'+id)); if(status>=400){ alert('Data tidak ditemukan'); return; }
      const h=data.header, it=data.items||[]; const div=document.getElementById('print');
      const itemsHtml = it.map(x=>`<div class="rc-item"><div class="name">${x.obat_nama||x.obat_kode}</div><div class="meta rc-small"><div>${x.qty} x ${fmt(x.harga_jual)}</div><div>${fmt(x.qty*x.harga_jual)}</div></div></div>`).join('');
      div.innerHTML = `
        <div class="receipt">
          <div class="rc-center">
            <div style="font-weight:700">${STORE.name}</div>
            <div class="rc-small">${STORE.address}</div>
            <div class="rc-small">${STORE.phone}</div>
          </div>
          <div class="rc-sep"></div>
          <div class="rc-small">No: ${h.no_nota}</div>
          <div class="rc-small">Tgl: ${h.tgl}</div>
          <div class="rc-small">Jenis: ${h.jenis} ¬∑ Pelanggan: ${h.pelanggan_kode||'-'}${h.dokter_sip? ' ¬∑ Dokter: '+h.dokter_sip:''}</div>
          <div class="rc-sep"></div>
          <div class="rc-items">${itemsHtml||'<div class="rc-small">(Tidak ada item)</div>'}</div>
          <div class="rc-sep"></div>
          <div class="rc-total">
            <div class="rc-row"><div>Total</div><div>Rp ${fmt(h.total)}</div></div>
          </div>
          <div class="rc-sep"></div>
          <div class="rc-center rc-small">Terima kasih atas kunjungan Anda</div>
        </div>`;
      window.print();
    }
    async function printEtiket(id){
      const {status,data}=await fetchJSON(api('/api/penjualan/'+id)); if(status>=400){ alert('Data tidak ditemukan'); return; }
      const h=data.header||{}; let patientName=null; if(h.pelanggan_kode){ try{ const r=await fetchJSON(api('/api/pelanggan/'+encodeURIComponent(h.pelanggan_kode))); if(r && r.data && r.data.nama) patientName=r.data.nama; }catch(e){} }
      const items=data.items||[];
      // Build labels: repeat per quantity with a safety cap to avoid accidental huge prints
      const labels=[]; items.forEach(x=>{ const copies=Math.max(1, Math.min(parseInt(x.qty||1,10), 20)); for(let i=0;i<copies;i++){ labels.push(x); } });
      const div=document.getElementById('print');
      const headerHtml = (n)=>`
        <div class="lb-head">${STORE.name.toUpperCase()}</div>
        <div class="lb-sub">${STORE.address}</div>`;
    const labelHtml = (x, idx)=>{
        const tgl = (h.tgl||'').split(' ')[0]||'';
        const namaObat = x.obat_nama||x.obat_kode||'';
        const aturan = x.dosis || x.etiket || '';
  return `<div class="label-box lb-small">
          ${headerHtml(idx)}
          <div class="lb-row"><div>No.</div><div>: ${h.no_nota||''}</div><div>Tgl :</div><div>${tgl}</div></div>
      <div class="lb-row"><div>Nama</div><div class="lb-colspan">: ${namaObat}</div></div>
          <div class="lb-row lb-colspan"><div>Aturan Pakai</div><div class="lb-colspan">: ${aturan||''}</div></div>
          <div class="lb-row lb-colspan" style="margin-top:2mm">
            <div class="lb-colspan" style="display:grid; grid-template-columns: 1fr 1fr; gap:2mm;">
              <div class="lb-check"><span class="box"></span><span>Tablet</span></div>
              <div class="lb-check"><span class="box"></span><span>Kapsul</span></div>
              <div class="lb-check"><span class="box"></span><span>Bungkus</span></div>
              <div class="lb-check"><span class="box"></span><span>Sendok</span></div>
            </div>
          </div>
          <div class="lb-footer"><strong>Kocok Dahulu</strong></div>
        </div>`;
      };
      div.innerHTML = `<div class="labels-grid">${labels.map(labelHtml).join('')}</div>`;
      window.print();
    }
    window.printNota = printNota; window.printEtiket = printEtiket;

    // pay
    document.getElementById('regenNota').addEventListener('click', ()=> setNota(genNota()));

    document.getElementById('pay').addEventListener('click', async () => {
      const errBox = document.getElementById('payErr'); errBox.textContent='';
      const btn = document.getElementById('pay');
      if(!cart.length){ errBox.textContent='Keranjang kosong'; return; }
      const jenis = document.getElementById('jenis').value;
      const dokter = document.getElementById('dokter').value||null;
      const pelanggan = document.getElementById('pelanggan').value||null;
      const no_nota = (document.getElementById('noNota').value||'').trim() || null;
      const items = cart.map(x => ({ obat_kode:x.obat_kode, batch_no:null, qty:x.qty, harga_jual:x.harga_jual, dosis:x.dosis||null, etiket:x.etiket||null }));
      btn.disabled = true; const prevText = btn.textContent; btn.textContent='Menyimpan‚Ä¶';
      let {status, data} = await fetchJSON(api('/api/penjualan'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ no_nota, jenis, pelanggan_kode: pelanggan, dokter_sip: dokter, items }) });
      // If duplicate no_nota (unique constraint), regenerate once and retry
      if(status>=400 && data && typeof data.error==='string' && /Duplicate entry/i.test(data.error)){
        setNota(genNota());
        const retry_nota = document.getElementById('noNota').value;
        ({status, data} = await fetchJSON(api('/api/penjualan'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ no_nota: retry_nota, jenis, pelanggan_kode: pelanggan, dokter_sip: dokter, items }) }));
      }
      if(status>=400){ errBox.textContent = (data && (data.error||JSON.stringify(data.errors))) || 'Gagal simpan'; btn.disabled=false; btn.textContent=prevText; return; }
  const nota = data && (data.no_nota||data.id)||'(tidak diketahui)';
  const tot = data && data.total!=null ? data.total : 0;
  alert('Tersimpan. No Nota: '+nota+'\nTotal: Rp '+fmt(tot));
      cart.splice(0, cart.length); renderCart();
    clearDraft();
  // Pastikan filter kembali ke hari ini agar transaksi baru terlihat
  setTodayFilters();
  loadHistory();
      btn.disabled=false; btn.textContent=prevText;
    });

  // init: default to today
  setTodayFilters();
  // init: generate initial nota
  setNota(genNota());
  // Load draft if any (so user can lanjutkan dan tambah item lagi)
  if(!loadDraft()){ renderCart(); }
  loadHistory();
  </script>
</body>
</html>
