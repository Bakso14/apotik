<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css?v=1">
  <link rel="stylesheet" href="./admin.css?v=2">
  <style>
    /* Print only selected area */
    @media print {
      body * { visibility: hidden !important; }
      .print-target, .print-target * { visibility: visible !important; }
      .print-target { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; }
      .sidebar, .topbar { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="layout">
  <aside class="sidebar" data-include="sidebar"></aside>
    <main class="main">
      <div class="topbar" data-include="header"></div>
      <div class="content">
        <div class="card" style="margin-bottom:12px">
        <div class="row" style="gap:8px;align-items:end;flex-wrap:wrap">
          <div><label>Periode dari</label><input type="date" id="from"></div>
          <div><label>sampai</label><input type="date" id="to"></div>
          <div><button class="btn btn-sm" id="apply">Terapkan</button><button class="btn btn-sm" id="today">Hari ini</button></div>
        </div>
        </div>
        <h2 class="page-title">Laporan Periode</h2>
        <div class="cards">
      <div class="card" id="card-ringkasan">
            <h3>Ringkasan Penjualan</h3>
            <div class="row" style="gap:6px;margin:6px 0">
              <button class="btn btn-sm" onclick="exportCSV('r_rows',['Tanggal','Transaksi','Total'])">Export CSV</button>
        <button class="btn btn-sm" onclick="printAreaById('card-ringkasan')">Print</button>
            </div>
            <div class="row" style="gap:12px"><div>Transaksi: <strong id="r_trx">0</strong></div><div>Total: <strong id="r_total">0</strong></div></div>
            <table class="table" style="margin-top:8px"><thead><tr><th>Tgl</th><th>Transaksi</th><th>Total</th></tr></thead><tbody id="r_rows"></tbody></table>
          </div>
      <div class="card" id="card-top">
            <h3>Obat Terlaris</h3>
            <div class="row" style="gap:6px;margin:6px 0">
              <button class="btn btn-sm" onclick="exportCSV('top_rows',['Kode','Nama','Qty','Omzet'])">Export CSV</button>
        <button class="btn btn-sm" onclick="printAreaById('card-top')">Print</button>
            </div>
            <table class="table"><thead><tr><th>Kode</th><th>Nama</th><th>Qty</th><th>Omzet</th></tr></thead><tbody id="top_rows"></tbody></table>
          </div>
      <div class="card" id="card-jenis">
            <h3>Jenis Penjualan</h3>
            <div class="row" style="gap:6px;margin:6px 0">
              <button class="btn btn-sm" onclick="exportCSV('jenis_rows',['Jenis','Transaksi','Total'])">Export CSV</button>
        <button class="btn btn-sm" onclick="printAreaById('card-jenis')">Print</button>
            </div>
            <table class="table"><thead><tr><th>Jenis</th><th>Transaksi</th><th>Total</th></tr></thead><tbody id="jenis_rows"></tbody></table>
          </div>
      <div class="card" id="card-stok">
            <h3>Stok Obat</h3>
            <div class="row" style="gap:6px;margin:6px 0">
              <button class="btn btn-sm" onclick="exportCSV('stok_rows',['Kode','Nama','Golongan','Stok','Expired'])">Export CSV</button>
        <button class="btn btn-sm" onclick="printAreaById('card-stok')">Print</button>
            </div>
            <table class="table"><thead><tr><th>Kode</th><th>Nama</th><th>Golongan</th><th>Stok</th><th>Expired</th></tr></thead><tbody id="stok_rows"></tbody></table>
          </div>
      <div class="card" id="card-pelanggan">
            <h3>Pelanggan</h3>
            <div class="row" style="gap:6px;margin:6px 0">
              <button class="btn btn-sm" onclick="exportCSV('pel_rows',['Kode','Nama','JK','HP','Alamat'])">Export CSV</button>
        <button class="btn btn-sm" onclick="printAreaById('card-pelanggan')">Print</button>
            </div>
            <table class="table"><thead><tr><th>Kode</th><th>Nama</th><th>JK</th><th>HP</th><th>Alamat</th></tr></thead><tbody id="pel_rows"></tbody></table>
          </div>
        </div>
        <div class="card" style="margin-top:24px">
          <h2 class="page-title">Laporan Pembelian</h2>
          <div class="cards cards-2">
      <div class="card" id="card-nota">
              <h3>Cetak Per Nota</h3>
              <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
                <input id="nota" placeholder="No Faktur" />
                <button class="btn" id="cetakNota">Tampilkan</button>
        <button class="btn" id="printNota">Cetak</button>
              </div>
              <div id="notaView" class="mt"></div>
            </div>
      <div class="card" id="card-pembelian-per">
              <h3>Periode / Per Supplier</h3>
              <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
                <label>Dari <input type="date" id="from" /></label>
                <label>Sampai <input type="date" id="to" /></label>
                <label>Supplier <input id="sup" placeholder="Supplier kode (opsional)" /></label>
                <button class="btn" id="cetakPer">Tampilkan</button>
        <button class="btn" id="printPer">Cetak</button>
              </div>
              <table class="table">
                <thead><tr><th>Tgl</th><th>No Faktur</th><th>Supplier</th><th>Obat</th><th>Qty</th><th>Harga</th><th>Subtotal</th></tr></thead>
                <tbody id="perRows"></tbody>
                <tfoot><tr><td colspan="6" style="text-align:right">Total</td><td id="perTotal">0</td></tr></tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script src="./app.js?v=2"></script>
  <script src="./include.js?v=1"></script>
  <script>
    function printAreaById(id){
      const el = document.getElementById(id);
      if(!el){ window.print(); return; }
      el.classList.add('print-target');
      // Give the browser a tick to apply styles
      setTimeout(()=>{
        window.print();
        setTimeout(()=>{ el.classList.remove('print-target'); }, 50);
      }, 0);
    }
    window.SIDEBAR_ACTIVE = 'laporan';
    (async function(){ const r = await fetchJSON(api('/api/me')); if(!r.data || !r.data.user){ location.href='./login.html'; } })();
    function todayRange(){ const d=new Date(); const s=d.toISOString().slice(0,10); return [s,s]; }
    function formatIDR(n){ try{ return Number(n||0).toLocaleString('id-ID'); }catch(e){ return n; } }
    async function load(){
      const from=document.getElementById('from').value, to=document.getElementById('to').value;
      const s=await fetchJSON(api(`/api/reports/penjualan?from=${from}&to=${to}`));
      if(s.status===401){ location.href='./login.html'; return; }
      const sum=s.data.summary||{trx:0,total:0};
      document.getElementById('r_trx').textContent=sum.trx||0;
      document.getElementById('r_total').textContent=formatIDR(sum.total||0);
      const tbody=document.getElementById('r_rows'); tbody.innerHTML='';
      (s.data.rows||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.tgl}</td><td>${r.trx}</td><td>${formatIDR(r.total)}</td>`; tbody.appendChild(tr); });
      const top=await fetchJSON(api(`/api/reports/obat-terlaris?from=${from}&to=${to}&limit=10`));
      const tbTop=document.getElementById('top_rows'); tbTop.innerHTML=''; (top.data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.obat_kode}</td><td>${r.nama||''}</td><td>${r.qty}</td><td>${formatIDR(r.omzet)}</td>`; tbTop.appendChild(tr); });
      const jenis=await fetchJSON(api(`/api/reports/jenis?from=${from}&to=${to}`));
      const tbJenis=document.getElementById('jenis_rows'); tbJenis.innerHTML=''; (jenis.data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.jenis}</td><td>${r.trx}</td><td>${formatIDR(r.total)}</td>`; tbJenis.appendChild(tr); });
      const stok=await fetchJSON(api('/api/reports/stok-obat'));
      const tbStok=document.getElementById('stok_rows'); tbStok.innerHTML=''; (stok.data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.kode}</td><td>${r.nama}</td><td>${r.golongan}</td><td>${r.stok}</td><td>${r.expired_date||''}</td>`; tbStok.appendChild(tr); });
      const pel=await fetchJSON(api('/api/reports/pelanggan'));
      const tbPel=document.getElementById('pel_rows'); tbPel.innerHTML=''; (pel.data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.kode}</td><td>${r.nama}</td><td>${r.jenis_kelamin||''}</td><td>${r.no_hp||''}</td><td>${r.alamat||''}</td>`; tbPel.appendChild(tr); });
    }
    document.getElementById('apply').onclick=()=>load();
    document.getElementById('today').onclick=()=>{ const [a,b]=todayRange(); document.getElementById('from').value=a; document.getElementById('to').value=b; load(); };
    // init: today
    (function(){ const [a,b]=todayRange(); document.getElementById('from').value=a; document.getElementById('to').value=b; load(); })();
    function exportCSV(tbodyId, headers){
      const tbody=document.getElementById(tbodyId); if(!tbody) return;
      const rows=[headers];
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const cols=[...tr.children].map(td=>(''+td.textContent).replaceAll('"','""'));
        rows.push(cols);
      });
      const csv=rows.map(r=>r.map(x=>`"${x}"`).join(',')).join('\r\n');
      const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download=(headers?.[0]||'export')+'-'+Date.now()+'.csv'; a.click();
    }
    async function fetchNota(){
      const no = document.getElementById('nota').value.trim(); if(!no){ alert('Isi No Faktur'); return; }
      const {status,data} = await fetchJSON(api('/api/pembelian/detail?no_faktur='+encodeURIComponent(no)));
      if(status>=400){ alert((data&&data.error)||'Gagal'); return; }
      const el = document.getElementById('notaView');
      const h = data.header; const items = data.items||[];
      let html = `<div style="padding:10px; border:1px solid #eee">`
              + `<div><strong>No Faktur:</strong> ${h.no_faktur}</div>`
              + `<div><strong>Tanggal:</strong> ${h.tgl}</div>`
              + `<div><strong>Supplier:</strong> ${h.supplier_kode}</div>`
              + `<hr/>`
              + `<table class="table"><thead><tr><th>Obat</th><th>Batch</th><th>Exp</th><th>Qty</th><th>Harga</th><th>Subtotal</th></tr></thead><tbody>`;
      let total=0; items.forEach(it=>{ const sub= (it.qty||0)*(it.harga_beli||0); total+=sub; html += `<tr><td>${it.obat_kode}</td><td>${it.batch_no||''}</td><td>${it.expired_date||''}</td><td>${it.qty||0}</td><td>${it.harga_beli||0}</td><td>${sub||0}</td></tr>`; });
      html += `</tbody><tfoot><tr><td colspan=\"5\" style=\"text-align:right\">Total</td><td>${total}</td></tr></tfoot></table></div>`;
      el.innerHTML = html;
    }
    document.getElementById('cetakNota').onclick = fetchNota;
  document.getElementById('printNota').onclick = ()=>{ printAreaById('card-nota'); };
    async function fetchPer(){
      const from = document.getElementById('from').value; const to = document.getElementById('to').value; const sup = document.getElementById('sup').value.trim();
      const qs = `from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}${sup?`&supplier_kode=${encodeURIComponent(sup)}`:''}`;
      const {status,data} = await fetchJSON(api('/api/report/pembelian?'+qs));
      if(status>=400){ alert((data&&data.error)||'Gagal'); return; }
      const tb = document.getElementById('perRows'); tb.innerHTML='';
      let total=0;
      (data||[]).forEach(r=>{ const sub=(r.qty||0)*(r.harga_beli||0); total+=sub; const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.tgl}</td><td>${r.no_faktur}</td><td>${r.supplier_kode}</td><td>${r.obat_kode}</td><td>${r.qty}</td><td>${r.harga_beli}</td><td>${sub}</td>`; tb.appendChild(tr); });
      document.getElementById('perTotal').textContent = total;
    }
    document.getElementById('cetakPer').onclick = fetchPer;
  document.getElementById('printPer').onclick = ()=>{ printAreaById('card-pembelian-per'); };
  </script>
</body>
</html>
